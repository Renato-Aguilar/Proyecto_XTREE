<!-- Views/auth/change-password.ejs -->
<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('../partials/head', { cssFile: 'auth.css' }) %>
</head>
<body>
  <div class="bg-animation"></div>
  <%- include('../partials/header') %>

  <main class="auth-container">
    <div class="auth-box register-box">
      <div class="auth-header">
        <h1>Cambiar Contraseña</h1>
        <p>Actualiza tu contraseña para mantener tu cuenta segura</p>
      </div>

      <!-- Mensajes Flash -->
      <% if (error && error.length > 0) { %>
        <div class="alert alert-error">
          <i class="fa-solid fa-circle-exclamation"></i>
          <%= error[0] %>
        </div>
      <% } %>

      <% if (success && success.length > 0) { %>
        <div class="alert alert-success">
          <i class="fa-solid fa-circle-check"></i>
          <%= success[0] %>
        </div>
      <% } %>

      <form action="/profile/change-password" method="POST" class="auth-form">
        <div class="form-group">
          <label for="contrasena_actual">
            <i class="fa-solid fa-lock"></i>
            Contraseña Actual
          </label>
          <div style="position: relative;">
            <input 
              type="password" 
              id="contrasena_actual" 
              name="contrasena_actual" 
              placeholder="Tu contraseña actual"
              required
              autocomplete="current-password"
            >
          </div>
        </div>

        <div class="form-group">
          <label for="contrasena_nueva">
            <i class="fa-solid fa-lock"></i>
            Contraseña Nueva
          </label>
          <div style="position: relative;">
            <input 
              type="password" 
              id="contrasena_nueva" 
              name="contrasena_nueva" 
              placeholder="Mínimo 8 caracteres"
              required
              minlength="8"
              autocomplete="new-password"
            >
          </div>
        </div>

        <!-- Indicador de fortaleza -->
        <div class="password-strength" id="passwordStrength">
          <div class="strength-bar">
            <div class="strength-fill"></div>
          </div>
          <p class="strength-text">Seguridad: <span>-</span></p>
        </div>

        <!-- Requisitos de contraseña -->
        <div class="password-requirements" id="passwordRequirements">
          <div class="requirement" id="req-length">
            <i class="fa-solid fa-circle-xmark"></i>
            <span>Mínimo 8 caracteres</span>
          </div>
          <div class="requirement" id="req-uppercase">
            <i class="fa-solid fa-circle-xmark"></i>
            <span>Al menos una mayúscula</span>
          </div>
          <div class="requirement" id="req-lowercase">
            <i class="fa-solid fa-circle-xmark"></i>
            <span>Al menos una minúscula</span>
          </div>
          <div class="requirement" id="req-number">
            <i class="fa-solid fa-circle-xmark"></i>
            <span>Al menos un número</span>
          </div>
          <div class="requirement" id="req-special">
            <i class="fa-solid fa-circle-xmark"></i>
            <span>Al menos un carácter especial (!@#$%^&*...)</span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmar_contrasena">
            <i class="fa-solid fa-lock-open"></i>
            Confirmar Contraseña Nueva
          </label>
          <div style="position: relative;">
            <input 
              type="password" 
              id="confirmar_contrasena" 
              name="confirmar_contrasena" 
              placeholder="Repite tu contraseña"
              required
              minlength="8"
              autocomplete="new-password"
            >
          </div>
          <small class="form-hint" id="matchHint"></small>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <a href="/profile" class="btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding: 15px;">
            <i class="fa-solid fa-arrow-left"></i>
            Cancelar
          </a>
          <button type="submit" class="btn-primary" style="flex: 1;">
            <i class="fa-solid fa-shield-halved"></i>
            Cambiar Contraseña
          </button>
        </div>
      </form>

      <div class="auth-footer">
        <p>
          <i class="fa-solid fa-info-circle"></i>
          Recomendamos cambiar tu contraseña cada 3 meses para mayor seguridad.
        </p>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script>
    const passwordInput = document.getElementById('contrasena_nueva');
    const confirmInput = document.getElementById('confirmar_contrasena');

    // Validar requisitos de contraseña
    function validatePasswordRequirements(value) {
      return {
        length: value.length >= 8,
        uppercase: /[A-Z]/.test(value),
        lowercase: /[a-z]/.test(value),
        number: /[0-9]/.test(value),
        special: /[!@#$%^&*(),.?":{}|<>_\-]/.test(value)
      };
    }

    // Actualizar indicadores
    function updateRequirementIndicators(requirements) {
      Object.keys(requirements).forEach(key => {
        const element = document.getElementById(`req-${key}`);
        if (element) {
          if (requirements[key]) {
            element.classList.add('met');
            element.querySelector('i').className = 'fa-solid fa-circle-check';
          } else {
            element.classList.remove('met');
            element.querySelector('i').className = 'fa-solid fa-circle-xmark';
          }
        }
      });
    }

    // Validar fortaleza de contraseña
    passwordInput.addEventListener('input', function() {
      const value = this.value;
      const requirements = validatePasswordRequirements(value);
      updateRequirementIndicators(requirements);

      const strengthFill = document.querySelector('.strength-fill');
      const strengthText = document.querySelector('.strength-text span');
      
      const metRequirements = Object.values(requirements).filter(Boolean).length;
      let strength = metRequirements;
      let label = '';
      let color = '';

      if (strength <= 2) {
        label = 'Débil';
        color = '#ff0000';
      } else if (strength <= 4) {
        label = 'Media';
        color = '#ffa500';
      } else {
        label = 'Fuerte';
        color = '#00ff00';
      }

      strengthFill.style.width = (strength * 20) + '%';
      strengthFill.style.background = color;
      strengthText.textContent = label;
      strengthText.style.color = color;
    });

    // Validar que coincidan las contraseñas
    confirmInput.addEventListener('input', function() {
      const matchHint = document.getElementById('matchHint');
      if (this.value && passwordInput.value !== this.value) {
        matchHint.textContent = 'Las contraseñas no coinciden';
        matchHint.style.color = '#ff6666';
      } else if (this.value && passwordInput.value === this.value) {
        matchHint.textContent = 'Las contraseñas coinciden ✓';
        matchHint.style.color = '#00ff00';
      } else {
        matchHint.textContent = '';
      }
    });
  </script>
</body>
</html>