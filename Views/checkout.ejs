<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('partials/head', { cssFile: 'checkout.css' }) %>
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=USD"></script>
</head>
<body>
  <div class="bg-animation"></div>
  <%- include('partials/header') %>

  <main class="checkout-container">
    <div class="checkout-header">
      <h1>
        <i class="fa-solid fa-lock"></i>
        Pago Seguro
      </h1>
      <p>Completa tu compra de forma segura con PayPal</p>
    </div>

    <!-- Mensajes Flash -->
    <% if (locals.error && error.length > 0) { %>
      <div class="alert alert-error">
        <i class="fa-solid fa-circle-exclamation"></i>
        <%= error[0] %>
      </div>
    <% } %>

    <div class="checkout-content">
      <!-- Formulario de pago -->
      <div class="checkout-form">
        <div class="form-section">
          <h2>
            <i class="fa-brands fa-paypal"></i>
            Pagar con PayPal
          </h2>
          
          <div class="payment-notice">
            <i class="fa-solid fa-info-circle"></i>
            <p><strong>Modo de prueba:</strong> Este es un entorno de testing. Usa las credenciales de prueba de PayPal Sandbox para simular pagos.</p>
          </div>

          <!-- Contenedor de botones de PayPal -->
          <div id="paypal-button-container"></div>

          <!-- Mensaje de procesamiento -->
          <div id="payment-processing" style="display: none; text-align: center; padding: 20px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: #00ff00;"></i>
            <p style="color: #00ff00; margin-top: 10px;">Procesando pago...</p>
          </div>
        </div>

        <!-- Dirección de envío -->
        <div class="form-section">
          <h2>
            <i class="fa-solid fa-truck"></i>
            Dirección de Envío
          </h2>
          
          <div class="form-group">
            <label>Dirección registrada</label>
            <div style="background: rgba(0, 255, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 255, 0, 0.3);">
              <p style="color: #00ff00; margin: 0;">
                <i class="fa-solid fa-location-dot"></i>
                <%= userAddress || 'No especificada' %>
              </p>
            </div>
            <% if (!userAddress) { %>
              <small style="color: #ff6666; margin-top: 10px; display: block;">
                <i class="fa-solid fa-warning"></i>
                Por favor actualiza tu dirección en tu perfil
              </small>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Resumen del pedido -->
      <div class="order-summary">
        <div class="summary-card">
          <h2>Resumen del Pedido</h2>
          
          <div class="summary-items">
            <% cartItems.forEach(item => { %>
              <div class="summary-item">
                <div class="item-name">
                  <strong><%= item.nombre %></strong>
                  <br>
                  <small style="color: #999;">
                    <%= item.cantidad %> pack<%= item.cantidad > 1 ? 's' : '' %> 
                    (<%= item.unidades_totales %> unidades)
                  </small>
                  <% if (item.descuento > 0) { %>
                    <br>
                    <span style="color: #00ff00; font-size: 0.85rem;">
                      <i class="fa-solid fa-tag"></i> <%= item.descuento %>% OFF
                    </span>
                  <% } %>
                </div>
                <div class="item-price">
                  <% if (item.cantidad > 1) { %>
                    <small style="display: block; color: #999;">
                      $<%= item.precio_por_pack.toLocaleString('es-CL') %> c/u
                    </small>
                  <% } %>
                  <strong>$<%= item.precio.toLocaleString('es-CL') %></strong>
                </div>
              </div>
            <% }) %>
          </div>

          <div class="summary-divider"></div>

          <div class="summary-row">
            <span>Subtotal:</span>
            <span>$<%= total.toLocaleString('es-CL') %> CLP</span>
          </div>

          <div class="summary-row">
            <span>Envío:</span>
            <span class="free">GRATIS</span>
          </div>

          <div class="summary-divider"></div>

          <div class="summary-row total">
            <span>Total:</span>
            <span class="total-price">$<%= total.toLocaleString('es-CL') %> CLP</span>
          </div>

          <div style="background: rgba(255, 165, 0, 0.1); padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px solid rgba(255, 165, 0, 0.3);">
            <small style="color: #ffa500; display: flex; align-items: center; gap: 8px;">
              <i class="fa-solid fa-info-circle"></i>
              Aproximadamente $<%= (total / 1000).toFixed(2) %> USD
            </small>
          </div>
        </div>

        <!-- Información de seguridad -->
        <div class="security-info">
          <div class="security-item">
            <i class="fa-solid fa-shield-halved"></i>
            <div>
              <strong>Pago 100% Seguro</strong>
              <p>PayPal protege tu información financiera</p>
            </div>
          </div>

          <div class="security-item">
            <i class="fa-solid fa-truck-fast"></i>
            <div>
              <strong>Envío Gratis</strong>
              <p>En todos tus pedidos sin mínimo de compra</p>
            </div>
          </div>

          <div class="security-item">
            <i class="fa-solid fa-rotate-left"></i>
            <div>
              <strong>Devoluciones</strong>
              <p>30 días para devolver tu producto</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script>
    // Renderizar botones de PayPal
    paypal.Buttons({
      style: {
        layout: 'vertical',
        color: 'gold',
        shape: 'rect',
        label: 'paypal'
      },

      // Crear orden
      createOrder: async function() {
        try {
          const response = await fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();
          
          if (data.id) {
            return data.id;
          } else {
            throw new Error('No se pudo crear la orden');
          }
        } catch (error) {
          console.error('Error al crear orden:', error);
          alert('Error al iniciar el pago. Por favor intenta nuevamente.');
        }
      },

      // Aprobar pago
      onApprove: async function(data) {
        try {
          // Mostrar mensaje de procesamiento
          document.getElementById('paypal-button-container').style.display = 'none';
          document.getElementById('payment-processing').style.display = 'block';

          const response = await fetch('/api/paypal/capture-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderID: data.orderID
            })
          });

          const result = await response.json();

          if (result.success) {
            // Redirigir a página de éxito
            window.location.href = '/checkout/success';
          } else {
            throw new Error(result.error || 'Error al procesar el pago');
          }
        } catch (error) {
          console.error('Error al capturar pago:', error);
          document.getElementById('payment-processing').style.display = 'none';
          document.getElementById('paypal-button-container').style.display = 'block';
          alert('Error al procesar el pago: ' + error.message);
        }
      },

      // Cancelar pago
      onCancel: function() {
        alert('Pago cancelado. Puedes intentar nuevamente cuando estés listo.');
      },

      // Error en el pago
      onError: function(err) {
        console.error('Error de PayPal:', err);
        alert('Ocurrió un error con PayPal. Por favor intenta nuevamente.');
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>