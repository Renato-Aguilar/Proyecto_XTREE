<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('partials/head', { cssFile: 'detalle-pedido.css' }) %>
</head>
<body>
  <div class="bg-animation"></div>
  <%- include('partials/header') %>

  <main class="orders-container">
    <div class="orders-header">
      <h1>
        <i class="fa-solid fa-box-open"></i>
        Detalle del Pedido #<%= order.id_orden %>
      </h1>
      <p>Información completa de tu pedido</p>
    </div>

    <!-- Mensajes Flash -->
    <% if (locals.error && error.length > 0) { %>
      <div class="alert alert-error">
        <i class="fa-solid fa-circle-exclamation"></i>
        <%= error[0] %>
      </div>
    <% } %>

    <% if (locals.success && success.length > 0) { %>
      <div class="alert alert-success">
        <i class="fa-solid fa-circle-check"></i>
        <%= success[0] %>
      </div>
    <% } %>

    <div class="order-detail-grid">
      <!-- Información del pedido -->
      <div class="detail-section">
        <div class="order-info-card">
          <h2>
            <i class="fa-solid fa-info-circle"></i>
            Información del Pedido
          </h2>
          
          <div class="info-row">
            <span class="info-label">Número de Pedido:</span>
            <span class="info-value">#<%= order.id_orden %></span>
          </div>

          <div class="info-row">
            <span class="info-label">Fecha:</span>
            <span class="info-value">
              <%= new Date(order.fecha_creacion).toLocaleDateString('es-CL', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) %>
            </span>
          </div>

          <!-- ✅ MOSTRAR SI HAY PROBLEMA EN EL PEDIDO -->
          <% if (order.tiene_problema) { %>
            <div class="info-row problema-row">
              <span class="info-label">
                <i class="fa-solid fa-exclamation-triangle"></i>
                Estado del Problema:
              </span>
              <span class="info-value problema">Con Problema</span>
            </div>

            <div class="info-row">
              <span class="info-label">Descripción del Problema:</span>
              <span class="info-value"><%= order.descripcion_problema %></span>
            </div>
          <% } else { %>
            <div class="info-row">
              <span class="info-label">
                <i class="fa-solid fa-check-circle"></i>
                Estado del Pedido:
              </span>
              <span class="info-value success">Sin Problemas</span>
            </div>
          <% } %>

          <div class="info-row total-row">
            <span class="info-label">Total Pagado:</span>
            <span class="info-value total">$<%= order.monto_total.toLocaleString('es-CL') %></span>
          </div>
        </div>

        <!-- Productos del pedido -->
        <div class="order-products-card">
          <h2>
            <i class="fa-solid fa-shopping-bag"></i>
            Productos
          </h2>
          
          <div class="products-list">
            <% details.forEach(item => { %>
              <div class="product-item">
                <div class="product-image">
                  <img src="<%= item.imagen_url %><%= item.imagen_url && !item.imagen_url.includes('.') ? '.png' : '' %>" 
                       alt="<%= item.nombre %>">
                </div>
                
                <div class="product-info">
                  <h3><%= item.nombre %></h3>
                  <p class="product-quantity">Cantidad: <%= item.cantidad %> unidades</p>
                  <p class="product-price-unit">$<%= item.precio_unitario.toLocaleString('es-CL') %> c/u</p>
                </div>
                
                <div class="product-total">
                  <span class="total-label">Subtotal</span>
                  <span class="total-amount">$<%= (item.cantidad * item.precio_unitario).toLocaleString('es-CL') %></span>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>

      <!-- Seguimiento del pedido -->
      <div class="tracking-section">
        <div class="tracking-card">
          <h2>
            <i class="fa-solid fa-truck-fast"></i>
            Seguimiento del Pedido
          </h2>
          
          <div class="tracking-timeline">
            <% tracking.forEach((item, index) => { %>
              <div class="timeline-item <%= index === tracking.length - 1 ? 'active' : 'completed' %>">
                <div class="timeline-marker">
                  <i class="fa-solid fa-<%= getIconForStatus(item.estado) %>"></i>
                </div>
                <div class="timeline-content">
                  <h3><%= item.estado %></h3>
                  <p class="timeline-date">
                    <%= new Date(item.fecha).toLocaleDateString('es-CL', { 
                      month: 'short', 
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) %>
                  </p>
                </div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- Acciones -->
        <div class="actions-card">
          <h3>Acciones</h3>
          
          <a href="/mis-pedidos" class="btn-action secondary">
            <i class="fa-solid fa-arrow-left"></i>
            Volver a Mis Pedidos
          </a>
          
          <button class="btn-action" onclick="window.print()">
            <i class="fa-solid fa-print"></i>
            Imprimir Detalle
          </button>
          
          <a href="/comprar" class="btn-action primary">
            <i class="fa-solid fa-shopping-cart"></i>
            Comprar de Nuevo
          </a>
        </div>

        <!-- Ayuda -->
        <div class="help-card">
          <h3>
            <i class="fa-solid fa-circle-question"></i>
            ¿Necesitas Ayuda?
          </h3>
          <% if (order.tiene_problema) { %>
            <p>Tu pedido ha sido reportado con un problema. Nuestro equipo está trabajando para resolverlo.</p>
            <p>Puedes contactarnos para más información:</p>
          <% } else { %>
            <p>Si tienes algún problema con tu pedido, contáctanos:</p>
          <% } %>
          <div class="contact-info">
            <p>
              <i class="fa-solid fa-envelope"></i>
              XtreeEnergy@gmail.com
            </p>
            <p>
              <i class="fa-solid fa-phone"></i>
              +56 9 0000 0000
            </p>
          </div>
          <a href="/ayuda/nueva" class="btn-help">
            <i class="fa-solid fa-headset"></i>
            Crear Solicitud de Ayuda
          </a>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
</body>
</html>