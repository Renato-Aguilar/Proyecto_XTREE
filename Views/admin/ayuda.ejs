<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('../partials/head', { cssFile: 'admin.css' }) %>
</head>
<body>
  <div class="bg-animation"></div>
  <%- include('../partials/header') %>

  <div class="admin-layout">
    <%- include('../partials/admin-sidebar') %>

    <main class="admin-content">
      <div class="admin-header">
        <h1>
          <i class="fa-solid fa-headset"></i>
          Centro de Ayuda
        </h1>
        <p>Gestiona las solicitudes de soporte de los clientes</p>
      </div>

      <!-- Mensajes Flash -->
      <% if (locals.error && error.length > 0) { %>
        <div class="alert alert-error">
          <i class="fa-solid fa-circle-exclamation"></i>
          <%= error[0] %>
        </div>
      <% } %>

      <% if (locals.success && success.length > 0) { %>
        <div class="alert alert-success">
          <i class="fa-solid fa-circle-check"></i>
          <%= success[0] %>
        </div>
      <% } %>

      <!-- Filtros por Estado -->
      <div class="filters-bar">
        <a href="/admin/ayuda" class="filter-btn <%= estadoFiltro === 'todas' ? 'active' : '' %>">
          <i class="fa-solid fa-list"></i>
          Todas
        </a>
        <a href="/admin/ayuda?estado=pendiente" class="filter-btn <%= estadoFiltro === 'pendiente' ? 'active' : '' %>">
          <i class="fa-solid fa-clock"></i>
          Pendientes
        </a>
        <a href="/admin/ayuda?estado=en_proceso" class="filter-btn <%= estadoFiltro === 'en_proceso' ? 'active' : '' %>">
          <i class="fa-solid fa-spinner"></i>
          En Proceso
        </a>
        <a href="/admin/ayuda?estado=resuelta" class="filter-btn <%= estadoFiltro === 'resuelta' ? 'active' : '' %>">
          <i class="fa-solid fa-check"></i>
          Resueltas
        </a>
        <a href="/admin/ayuda?estado=cerrada" class="filter-btn <%= estadoFiltro === 'cerrada' ? 'active' : '' %>">
          <i class="fa-solid fa-lock"></i>
          Cerradas
        </a>
      </div>

      <!-- Lista de Solicitudes -->
      <div class="help-requests-grid">
        <% if (solicitudes.length > 0) { %>
          <% solicitudes.forEach(solicitud => { %>
            <div class="help-request-card priority-<%= solicitud.prioridad %>">
              <div class="help-request-header">
                <div class="help-badges">
                  <span class="priority-badge <%= solicitud.prioridad %>">
                    <i class="fa-solid fa-flag"></i>
                    <%= solicitud.prioridad.toUpperCase() %>
                  </span>
                  <span class="status-badge <%= solicitud.estado %>">
                    <%= solicitud.estado.replace('_', ' ').toUpperCase() %>
                  </span>
                </div>
                <span class="help-id">#<%= solicitud.id_solicitud %></span>
              </div>

              <h3 class="help-subject"><%= solicitud.asunto %></h3>

              <p class="help-message"><%= solicitud.mensaje.substring(0, 150) %><%= solicitud.mensaje.length > 150 ? '...' : '' %></p>

              <div class="help-meta">
                <div class="help-user-info">
                  <i class="fa-solid fa-user"></i>
                  <span><%= solicitud.nombre %> <%= solicitud.apellido %></span>
                </div>
                <div class="help-email">
                  <i class="fa-solid fa-envelope"></i>
                  <span><%= solicitud.email %></span>
                </div>
                <% if (solicitud.id_orden) { %>
                  <div class="help-order">
                    <i class="fa-solid fa-shopping-bag"></i>
                    <span>Pedido #<%= solicitud.id_orden %></span>
                  </div>
                <% } %>
              </div>

              <div class="help-footer">
                <span class="help-date">
                  <i class="fa-solid fa-calendar"></i>
                  <%= new Date(solicitud.fecha_creacion).toLocaleString('es-CL') %>
                </span>
                <% if (solicitud.atendido_por) { %>
                  <span class="help-assigned">
                    <i class="fa-solid fa-user-check"></i>
                    Atendido por: <%= solicitud.admin_nombre %> <%= solicitud.admin_apellido %>
                  </span>
                <% } %>
              </div>

              <a href="/admin/ayuda/<%= solicitud.id_solicitud %>" class="btn-view-help">
                <i class="fa-solid fa-arrow-right"></i>
                Ver y Responder
              </a>
            </div>
          <% }) %>
        <% } else { %>
          <div class="empty-state-large">
            <i class="fa-solid fa-inbox"></i>
            <h3>No hay solicitudes</h3>
            <p>No se encontraron solicitudes con el filtro seleccionado</p>
          </div>
        <% } %>
      </div>
    </main>
  </div>

  <%- include('../partials/footer') %>
<script src="/js/admin-modal.js"></script>
</body>
</html>