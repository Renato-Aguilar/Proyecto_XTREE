<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('../partials/head', { cssFile: 'admin.css' }) %>
</head>
<body>
  <div class="bg-animation"></div>
  <%- include('../partials/header') %>

  <div class="admin-layout">
    <%- include('../partials/admin-sidebar') %>

    <main class="admin-content">
      <div class="admin-header">
        <h1>
          <i class="fa-solid fa-users"></i>
          Gestión de Usuarios
        </h1>
        <p>Administra los usuarios registrados en el sistema</p>
        <% if (!isSuperAdmin) { %>
          <div class="alert alert-info" style="margin-top: 15px;">
            <i class="fa-solid fa-info-circle"></i>
            Solo los superadministradores pueden cambiar roles de usuarios
          </div>
        <% } %>
      </div>

      <!-- Mensajes Flash -->
      <% if (locals.error && error.length > 0) { %>
        <div class="alert alert-error">
          <i class="fa-solid fa-circle-exclamation"></i>
          <%= error[0] %>
        </div>
      <% } %>

      <% if (locals.success && success.length > 0) { %>
        <div class="alert alert-success">
          <i class="fa-solid fa-circle-check"></i>
          <%= success[0] %>
        </div>
      <% } %>

      <!-- Tabla de Usuarios -->
      <div class="table-card">
        <div class="table-responsive">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Nombre Completo</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Registro</th>
                <th>Pedidos</th>
                <th>Gasto Total</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% if (usuarios.length > 0) { %>
                <% usuarios.forEach(usuario => { %>
                  <tr>
                    <td class="font-bold">#<%= usuario.id_usuario %></td>
                    <td>@<%= usuario.nombre_usuario %></td>
                    <td><%= usuario.nombre %> <%= usuario.apellido %></td>
                    <td><%= usuario.email %></td>
                    <td>
                      <span class="role-badge <%= usuario.rol %>">
                        <i class="fa-solid fa-<%= usuario.rol === 'superadmin' ? 'crown' : usuario.rol === 'admin' ? 'shield' : 'user' %>"></i>
                        <%= usuario.rol.toUpperCase() %>
                      </span>
                    </td>
                    <td><%= new Date(usuario.fecha_registro).toLocaleDateString('es-CL') %></td>
                    <td class="text-center"><%= usuario.total_pedidos %></td>
                    <td class="text-green font-bold">$<%= usuario.gasto_total.toLocaleString('es-CL') %></td>
                    <td class="actions-cell">
                      <% 
                        const esSuperAdmin = usuario.rol === 'superadmin';
                        const esUsuarioActual = usuario.id_usuario === user.id;
                        const puedeEditar = isSuperAdmin && !esSuperAdmin;
                        const razonDeshabilitado = esSuperAdmin ? 'No se puede modificar a un superadmin' : 
                                                  esUsuarioActual ? 'No puedes editarte a ti mismo' : '';
                      %>
                      <button 
                        onclick="editarUsuario(<%= usuario.id_usuario %>, '<%= usuario.nombre %>', '<%= usuario.apellido %>', '<%= usuario.email %>', '<%= usuario.rol %>')" 
                        class="btn-action"
                        <%= !puedeEditar ? 'disabled' : '' %>
                        title="<%= puedeEditar ? 'Editar Usuario' : razonDeshabilitado %>">
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="9" class="text-center">
                    <div class="empty-state">
                      <i class="fa-solid fa-users-slash"></i>
                      <p>No hay usuarios registrados</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <%- include('../partials/footer') %>

  <!-- Modal para Editar Usuario -->
  <div id="modalEditarUsuario" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Usuario</h3>
        <button class="modal-close" onclick="cerrarModal()">&times;</button>
      </div>
      <form id="formEditarUsuario" method="POST">
        <div class="modal-body">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" name="nombre" id="edit_nombre">
          </div>

          <div class="form-group">
            <label>Apellido</label>
            <input type="text" name="apellido" id="edit_apellido">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" id="edit_email">
          </div>

          <div class="form-group">
            <label>Dirección</label>
            <input type="text" name="direccion" id="edit_direccion" placeholder="Actualizar dirección (opcional)">
          </div>

          <% if (isSuperAdmin) { %>
            <div class="form-group">
              <label>Rol</label>
              <select name="rol" id="edit_rol">
                <option value="cliente">Cliente</option>
                <option value="admin">Administrador</option>
              </select>
              <small class="form-hint">
                <i class="fa-solid fa-warning"></i>
                Solo puedes cambiar entre Cliente y Administrador. El rol de Superadmin no se puede asignar desde aquí.
              </small>
            </div>
          <% } %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-primary">
            <i class="fa-solid fa-save"></i>
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/admin-modal.js"></script>

  <script>
    function editarUsuario(id, nombre, apellido, email, rol) {
      if (!modalManager) {
        console.error('Error: ModalManager no inicializado');
        return;
      }

      modalManager.open('modalEditarUsuario');
      
      const form = document.getElementById('formEditarUsuario');
      if (form) {
        form.action = `/admin/usuarios/${id}`;
        
        const nameInput = document.getElementById('edit_nombre');
        const lastNameInput = document.getElementById('edit_apellido');
        const emailInput = document.getElementById('edit_email');
        const roleSelect = document.getElementById('edit_rol');
        
        if (nameInput) nameInput.value = nombre;
        if (lastNameInput) lastNameInput.value = apellido;
        if (emailInput) emailInput.value = email;
        
        if (roleSelect) {
          <% if (isSuperAdmin) { %>
            const esSuperAdmin = rol === 'superadmin';
            const currentUserId = <%= user.id %>;
            const esUsuarioActual = id === currentUserId;
            
            if (esSuperAdmin || esUsuarioActual) {
              roleSelect.disabled = true;
              roleSelect.value = rol;
              roleSelect.title = esSuperAdmin 
                ? 'No se puede cambiar el rol de un superadmin' 
                : 'No puedes cambiar tu propio rol';
            } else {
              roleSelect.disabled = false;
              roleSelect.value = rol;
            }
          <% } %>
        }
      }
    }

    function cerrarModal() {
      if (modalManager) {
        modalManager.close('modalEditarUsuario');
      }
    }

    window.onclick = function(event) {
      const modal = document.getElementById('modalEditarUsuario');
      if (event.target === modal) {
        cerrarModal();
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('formEditarUsuario');
      
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const action = this.action;
          const formData = new FormData(this);
          
          const data = {};
          for (let [key, value] of formData.entries()) {
            data[key] = value;
          }
          
          console.log('Enviando actualización...');
          console.log('URL:', action);
          console.log('Método: PUT');
          console.log('Datos:', data);
          
          try {
            const response = await fetch(action, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(data)
            });
            
            console.log('Respuesta HTTP:', response.status, response.statusText);
            
            const result = await response.json();
            console.log('Datos de respuesta:', result);
            
            if (response.ok && result.success) {
              showNotification('Ok ' + (result.message || 'Usuario actualizado correctamente'), 'success');
              cerrarModal();
              
              setTimeout(() => {
                location.reload();
              }, 1500);
            } else {
              showNotification('Error: ' + (result.message || result.error || 'No especificado'), 'error');
            }
          } catch (error) {
            console.error('Error de red:', error);
            showNotification('Error de conexión: ' + error.message, 'error');
          }
        });
        
        console.log('Formulario de usuarios configurado con AJAX');
      } else {
        console.error('Formulario #formEditarUsuario no encontrado');
      }
    });
  </script>
</body>
</html>